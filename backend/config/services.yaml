parameters:
    # reCAPTCHA defaults (disabled by default)
    recaptcha_enabled_default: false
    recaptcha_min_score_default: 0.5

    # Synaplan public URL
    synaplan_url: '%env(SYNAPLAN_URL)%'

    # OIDC admin role claim values (comma-separated, case-insensitive)
    env(OIDC_ADMIN_ROLES): 'admin,realm-admin,synaplan-admin,administrator'

    # OIDC role claim paths (comma-separated dot-notation)
    # Use {client_id} as placeholder for OIDC_CLIENT_ID. Escape literal dots with \
    env(OIDC_ROLE_CLAIMS): 'realm_access.roles,resource_access.{client_id}.roles,groups'

    # Logging
    # LOG_FORMAT: json (default) or line (human-readable)
    # LOG_LEVEL: debug, info, notice, warning, error (see monolog.yaml)
    env(LOG_FORMAT): ''
    default_log_format: 'json'
    log_level_default: 'info'     # Production: less verbose
    log_level_dev: 'debug'        # Development: show everything

    # Optional API keys — empty string default means "not configured"
    env(ANTHROPIC_API_KEY): ''
    env(OPENAI_API_KEY): ''
    env(GROQ_API_KEY): ''
    env(GOOGLE_GEMINI_API_KEY): ''
    env(GOOGLE_CLOUD_PROJECT_ID): ''
    env(THEHIVE_API_KEY): ''
    env(HUGGINGFACE_API_KEY): ''
    env(BRAVE_SEARCH_API_KEY): ''
    env(DISCORD_WEBHOOK_URL): ''
    env(GMAIL_USERNAME): ''
    env(GMAIL_PASSWORD): ''
    env(TIKA_HTTP_USER): ''
    env(TIKA_HTTP_PASS): ''
    env(VECTOR_STORAGE_PROVIDER): ''
    env(QDRANT_SERVICE_URL): ''
    env(QDRANT_SERVICE_API_KEY): ''
    env(QDRANT_DOCUMENTS_COLLECTION): ''
    env(TRITON_SERVER_URL): ''
    env(GOOGLE_CLIENT_ID): ''
    env(GITHUB_CLIENT_ID): ''
    env(OIDC_CLIENT_ID): ''
    env(OIDC_DISCOVERY_URL): ''
    env(RECAPTCHA_SECRET_KEY): ''
    env(GOOGLE_CLIENT_SECRET): ''
    env(GITHUB_CLIENT_SECRET): ''
    env(OIDC_CLIENT_SECRET): ''
    env(STRIPE_SECRET_KEY): ''
    env(STRIPE_WEBHOOK_SECRET): ''
    env(STRIPE_PRICE_PRO): ''
    env(STRIPE_PRICE_TEAM): ''
    env(STRIPE_PRICE_BUSINESS): ''
    env(STRIPE_PAYMENT_METHODS): ''
    env(WHATSAPP_ACCESS_TOKEN): ''
    env(WHATSAPP_WEBHOOK_VERIFY_TOKEN): ''

    # Piper TTS Service default
    env(SYNAPLAN_TTS_URL): ''
    synaplan_tts_url_default: 'http://host.docker.internal:10200'

    # Plugins - mounted at /plugins in Docker, relative path for CI
    plugins_dir: '/plugins'

services:
    _defaults:
        autowire: true
        autoconfigure: true

    App\:
        resource: '../src/'
        exclude:
            - '../src/DependencyInjection/'
            - '../src/Entity/'
            - '../src/Kernel.php'

    # AI Providers - TestProvider supports all capabilities
    App\AI\Provider\TestProvider:
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.embedding' }
            - { name: 'app.ai.vision' }
            - { name: 'app.ai.image_generation' }
            - { name: 'app.ai.speech_to_text' }
            - { name: 'app.ai.text_to_speech' }
            - { name: 'app.ai.file_analysis' }

    App\AI\Provider\AnthropicProvider:
        arguments:
            $apiKey: '%env(ANTHROPIC_API_KEY)%'
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.vision' }

    App\AI\Provider\OpenAIProvider:
        arguments:
            $apiKey: '%env(OPENAI_API_KEY)%'
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.embedding' }
            - { name: 'app.ai.vision' }
            - { name: 'app.ai.image_generation' }
            - { name: 'app.ai.speech_to_text' }
            - { name: 'app.ai.text_to_speech' }

    App\AI\Provider\OllamaProvider:
        arguments:
            $baseUrl: '%env(OLLAMA_BASE_URL)%'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.embedding' }

    App\AI\Provider\TritonProvider:
        arguments:
            $serverUrl: '%env(TRITON_SERVER_URL)%'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.embedding' }

    App\AI\Provider\GroqProvider:
        arguments:
            $apiKey: '%env(GROQ_API_KEY)%'
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.vision' }
            - { name: 'app.ai.speech_to_text' }

    App\AI\Provider\GoogleProvider:
        arguments:
            $apiKey: '%env(GOOGLE_GEMINI_API_KEY)%'
            $projectId: '%env(GOOGLE_CLOUD_PROJECT_ID)%'
            $region: 'us-central1'
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.vision' }
            - { name: 'app.ai.image_generation' }
            - { name: 'app.ai.video_generation' }
            - { name: 'app.ai.text_to_speech' }

    App\AI\Provider\TheHiveProvider:
        arguments:
            $apiKey: '%env(THEHIVE_API_KEY)%'
        tags:
            - { name: 'app.ai.image_generation' }

    App\AI\Provider\PiperProvider:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
            $ttsUrl: '%env(default:synaplan_tts_url_default:SYNAPLAN_TTS_URL)%'
        tags:
            - { name: 'app.ai.text_to_speech' }

    App\AI\Provider\HuggingFaceProvider:
        arguments:
            $apiKey: '%env(HUGGINGFACE_API_KEY)%'
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.ai.chat' }
            - { name: 'app.ai.embedding' }
            - { name: 'app.ai.image_generation' }
            - { name: 'app.ai.video_generation' }

    # AI Facade
    App\AI\Service\AiFacade: ~

    # Whisper Service for Audio Transcription
    App\Service\WhisperService:
        arguments:
            $whisperBinary: '%env(WHISPER_BINARY)%'
            $whisperModelsPath: '%env(WHISPER_MODELS_PATH)%'
            $defaultModel: '%env(WHISPER_DEFAULT_MODEL)%'
            $ffmpegBinary: '%env(FFMPEG_BINARY)%'

    # Brave Search API Service
    App\Service\Search\BraveSearchService:
        arguments:
            $braveSearchApiKey: '%env(BRAVE_SEARCH_API_KEY)%'
            $braveSearchApiUrl: '%env(BRAVE_SEARCH_API_URL)%'
            $braveSearchEnabled: '%env(bool:BRAVE_SEARCH_ENABLED)%'
            $braveSearchCount: '%env(int:BRAVE_SEARCH_COUNT)%'
            $braveSearchCountry: '%env(BRAVE_SEARCH_COUNTRY)%'
            $braveSearchLang: '%env(BRAVE_SEARCH_SEARCH_LANG)%'

    # Discord Webhook Notification Service
    App\Service\DiscordNotificationService:
        arguments:
            $webhookUrl: '%env(DISCORD_WEBHOOK_URL)%'

    # WhatsApp Business API Service - Fully Dynamic Multi-Number Support
    # Uses cache + lock for atomic duplicate message detection (WhatsApp webhook retries)
    App\Service\WhatsAppService:
        arguments:
            $cache: '@cache.app'
            $lockFactory: '@lock.factory'
            $whatsappAccessToken: '%env(WHATSAPP_ACCESS_TOKEN)%'
            $whatsappEnabled: '%env(bool:WHATSAPP_ENABLED)%'
            $uploadsDir: '%kernel.project_dir%/var/uploads'
            $whatsappUserId: 2  # WhatsApp messages use User ID 2 for model selection
            $appUrl: '%env(APP_URL)%'

    # Webhook Controller - Bind WhatsApp Verify Token
    App\Controller\WebhookController:
        bind:
            $whatsappWebhookVerifyToken: '%env(WHATSAPP_WEBHOOK_VERIFY_TOKEN)%'

    # Message Processing Services
    App\Service\Message\MessagePreProcessor:
        arguments:
            $tikaBaseUrl: '%env(TIKA_BASE_URL)%'
            $uploadsDir: '%kernel.project_dir%/var/uploads'
    App\Service\Message\MessageSorter: ~
    App\Service\Message\MessageClassifier: ~
    App\Service\Message\InferenceRouter: ~
    App\Service\Message\MessageProcessor: ~

    # Message Handlers
    App\Service\Message\Handler\ChatHandler:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.message.handler' }

    App\Service\Message\Handler\MediaGenerationHandler:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.message.handler' }

    App\Service\Message\Handler\FileAnalysisHandler:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'app.message.handler' }

    # Circuit Breaker
    App\Service\CircuitBreaker: ~

    # Model Configuration Service
    App\Service\ModelConfigService: ~

    # Rate Limiter Service
    App\Service\RateLimiterService: ~

    # Internal Email Service (system emails - uses SMTP from ENV)
    App\Service\InternalEmailService: ~

    # Inbound Email Service (fetches emails from Gmail IMAP or Mailhog)
    App\Service\InboundEmailService:
        arguments:
            $mailhogApiUrl: 'http://mailhog:8025/api/v2'
            $gmailUsername: '%env(GMAIL_USERNAME)%'
            $gmailPassword: '%env(GMAIL_PASSWORD)%'

    # Process Emails Command
    App\Command\ProcessEmailsCommand:
        arguments:
            $appUrl: '%env(APP_URL)%'
        tags:
            - { name: 'console.command' }

    # Encryption Service (for sensitive data like IMAP passwords)
    App\Service\EncryptionService:
        arguments:
            $secretKey: '%env(APP_SECRET)%'

    # Social Login Controllers (Google & GitHub OAuth)
    App\Controller\GoogleAuthController:
        arguments:
            $googleClientId: '%env(GOOGLE_CLIENT_ID)%'
            $googleClientSecret: '%env(GOOGLE_CLIENT_SECRET)%'
            $appUrl: '%env(APP_URL)%'
            $frontendUrl: '%env(FRONTEND_URL)%'

    App\Controller\GitHubAuthController:
        arguments:
            $githubClientId: '%env(GITHUB_CLIENT_ID)%'
            $githubClientSecret: '%env(GITHUB_CLIENT_SECRET)%'
            $appUrl: '%env(APP_URL)%'
            $frontendUrl: '%env(FRONTEND_URL)%'

    # OIDC Discovery Controller
    App\Controller\OidcController:
        arguments:
            $oidcAutoRedirect: '%env(string:default::OIDC_AUTO_REDIRECT)%'

    # OIDC Token Service for Keycloak integration
    App\Service\OidcTokenService:
        arguments:
            $appEnv: '%env(APP_ENV)%'
            $oidcClientId: '%env(OIDC_CLIENT_ID)%'
            $oidcClientSecret: '%env(OIDC_CLIENT_SECRET)%'
            $oidcDiscoveryUrl: '%env(OIDC_DISCOVERY_URL)%'

    # Keycloak OIDC OAuth Controller
    App\Controller\KeycloakAuthController:
        arguments:
            $oidcClientId: '%env(OIDC_CLIENT_ID)%'
            $oidcClientSecret: '%env(OIDC_CLIENT_SECRET)%'
            $oidcDiscoveryUrl: '%env(OIDC_DISCOVERY_URL)%'
            $oidcAdminRoles: '%env(string:OIDC_ADMIN_ROLES)%'
            $oidcRoleClaims: '%env(string:OIDC_ROLE_CLAIMS)%'
            $appUrl: '%env(APP_URL)%'
            $frontendUrl: '%env(FRONTEND_URL)%'

    # Billing Service (checks if Stripe is configured)
    App\Service\BillingService:
        arguments:
            $stripeSecretKey: '%env(STRIPE_SECRET_KEY)%'
            $stripePricePro: '%env(STRIPE_PRICE_PRO)%'

    # Stripe Payment Controllers (with rate limiting via cache)
    App\Controller\SubscriptionController:
        arguments:
            $stripeSecretKey: '%env(STRIPE_SECRET_KEY)%'
            $stripePricePro: '%env(STRIPE_PRICE_PRO)%'
            $stripePriceTeam: '%env(STRIPE_PRICE_TEAM)%'
            $stripePriceBusiness: '%env(STRIPE_PRICE_BUSINESS)%'
            $frontendUrl: '%env(FRONTEND_URL)%'
            $stripePaymentMethods: '%env(STRIPE_PAYMENT_METHODS)%'
            $cache: '@cache.app'

    App\Controller\StripeWebhookController:
        arguments:
            $stripeWebhookSecret: '%env(STRIPE_WEBHOOK_SECRET)%'
            $stripeSecretKey: '%env(STRIPE_SECRET_KEY)%'
            $stripePricePro: '%env(STRIPE_PRICE_PRO)%'
            $stripePriceTeam: '%env(STRIPE_PRICE_TEAM)%'
            $stripePriceBusiness: '%env(STRIPE_PRICE_BUSINESS)%'
            $cache: '@cache.app'

    # Shared Chat Page Controller (serves Open Graph meta tags for social media)
    App\Controller\SharedChatPageController:
        arguments:
            $synaplanUrl: '%env(SYNAPLAN_URL)%'

    # Auth Providers Controller (returns enabled providers)
    App\Controller\AuthProvidersController:
        arguments:
            $googleClientId: '%env(string:default::GOOGLE_CLIENT_ID)%'
            $githubClientId: '%env(string:default::GITHUB_CLIENT_ID)%'
            $oidcClientId: '%env(string:default::OIDC_CLIENT_ID)%'
            $oidcDiscoveryUrl: '%env(string:default::OIDC_DISCOVERY_URL)%'
            $oidcAutoRedirect: '%env(string:default::OIDC_AUTO_REDIRECT)%'

    # OAuth State Service (signed tokens for CSRF protection)
    App\Service\OAuthStateService:
        arguments:
            $appSecret: '%env(APP_SECRET)%'

    # Token Service (Access/Refresh Tokens)
    App\Service\TokenService:
        arguments:
            $appEnv: '%kernel.environment%'

    # reCAPTCHA Service
    App\Service\RecaptchaService:
        arguments:
            $secretKey: '%env(RECAPTCHA_SECRET_KEY)%'
            $enabled: '%env(string:default:recaptcha_enabled_default:RECAPTCHA_ENABLED)%'
            $minScore: '%env(string:default:recaptcha_min_score_default:RECAPTCHA_MIN_SCORE)%'

    App\Service\Message\AgainHandler: ~

    # File Processing Services
    App\Service\File\TikaClient:
        arguments:
            $tikaUrl: '%env(TIKA_BASE_URL)%'
            $tikaTimeoutMs: '%env(int:TIKA_TIMEOUT_MS)%'
            $tikaRetries: '%env(int:TIKA_RETRIES)%'
            $tikaRetryBackoffMs: '%env(int:TIKA_RETRY_BACKOFF_MS)%'
            $tikaHttpUser: '%env(TIKA_HTTP_USER)%'
            $tikaHttpPass: '%env(TIKA_HTTP_PASS)%'

    App\Service\File\FileStorageService:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Controller\FileController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Controller\StreamController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Controller\FileServeController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Controller\StaticUploadController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'controller.service_arguments' }

    App\Controller\WidgetController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
        tags:
            - { name: 'controller.service_arguments' }

    App\Service\File\DataUrlFixer:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Controller\WidgetPublicController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Service\File\ThumbnailService:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    App\Service\File\OgImageService:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
            $frontendDir: '%kernel.project_dir%/../frontend'

    App\Service\File\PdfRasterizer:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
            $rasterizeDpi: '%env(int:RASTERIZE_DPI)%'
            $rasterizePageCap: '%env(int:RASTERIZE_PAGE_CAP)%'
            $rasterizeTimeoutMs: '%env(int:RASTERIZE_TIMEOUT_MS)%'

    App\Service\File\TextCleaner: ~

    App\Service\File\FileProcessor:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'
            $tikaMinLength: '%env(int:TIKA_MIN_LENGTH)%'
            $tikaMinEntropy: '%env(float:TIKA_MIN_ENTROPY)%'
            $ffmpegBinary: '%env(FFMPEG_BINARY)%'

    App\Service\File\TextChunker:
        arguments:
            $maxChunkSize: 500
            $overlapSize: 50
            $minChunkSize: 100

    App\Service\File\VectorizationService: ~

    # Qdrant Vector Search Client (User Memories)
    # Defaults to empty string when env vars not set (disables memory service gracefully)
    App\Service\VectorSearch\QdrantClientHttp:
        arguments:
            $httpClient: '@Symfony\Contracts\HttpClient\HttpClientInterface'
            $baseUrl: '%env(QDRANT_SERVICE_URL)%'
            $apiKey: '%env(QDRANT_SERVICE_API_KEY)%'

    App\Service\VectorSearch\QdrantClientInterface:
        alias: App\Service\VectorSearch\QdrantClientHttp
    # For Development without Qdrant: alias: App\Service\VectorSearch\QdrantClientMock

    # Monolog Formatter Factory (for env-based log format switching)
    App\Service\MonologFormatterFactory:
        arguments:
            $logFormat: '%env(default:default_log_format:LOG_FORMAT)%'

    # Monolog formatter service created by factory
    app.monolog_formatter:
        class: Monolog\Formatter\FormatterInterface
        factory: ['@App\Service\MonologFormatterFactory', 'createFormatter']

    # Plugin discovery
    # Note: Specific path mapping needed because plugin directory structure
    # (sortx/backend/) doesn't follow PSR-4 convention (SortX/)
    Plugin\SortX\:
        resource: '%plugins_dir%/sortx/backend/'
        exclude: '%plugins_dir%/sortx/backend/{Entity,migrations,tests}'

    Plugin\SortX\Controller\SortXController:
        arguments:
            $uploadDir: '%kernel.project_dir%/var/uploads'

    # System Configuration Service (Admin .env editor)
    App\Service\Admin\SystemConfigService:
        arguments:
            $projectDir: '%kernel.project_dir%'

    # Vector Storage Configuration
    App\Service\RAG\VectorStorage\VectorStorageConfig:
        arguments:
            $envProvider: '%env(VECTOR_STORAGE_PROVIDER)%'
            $qdrantServiceUrl: '%env(QDRANT_SERVICE_URL)%'
            $qdrantApiKey: '%env(QDRANT_SERVICE_API_KEY)%'
            $qdrantDocumentsCollection: '%env(QDRANT_DOCUMENTS_COLLECTION)%'

    # Vector Storage Implementations
    App\Service\RAG\VectorStorage\MariaDBVectorStorage: ~

    App\Service\RAG\VectorStorage\QdrantVectorStorage:
        arguments:
            $qdrantClient: '@App\Service\VectorSearch\QdrantClientHttp'

    # Vector Migration Service (MariaDB → Qdrant)
    App\Service\RAG\VectorStorage\VectorMigrationService:
        arguments:
            $qdrantStorage: '@App\Service\RAG\VectorStorage\QdrantVectorStorage'
            $qdrantClient: '@App\Service\VectorSearch\QdrantClientHttp'
            $mariaDbStorage: '@App\Service\RAG\VectorStorage\MariaDBVectorStorage'

    # Vector Storage Facade
    App\Service\RAG\VectorStorage\VectorStorageFacade:
        arguments:
            $mariaDbStorage: '@App\Service\RAG\VectorStorage\MariaDBVectorStorage'
            $qdrantStorage: '@App\Service\RAG\VectorStorage\QdrantVectorStorage'
            $config: '@App\Service\RAG\VectorStorage\VectorStorageConfig'

    # Alias for injection
    App\Service\RAG\VectorStorage\VectorStorageInterface:
        alias: App\Service\RAG\VectorStorage\VectorStorageFacade
