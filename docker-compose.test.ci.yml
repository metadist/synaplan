# CI overrides for docker-compose.test.yml
# This file configures the setup for CI by:
#   1. Using a pre-built Docker image (via APP_IMAGE env var)
#   2. Removing volume mounts to use the baked image content
#   3. whatsapp-stub: no ports (stub only reachable in-network), no container_name
#
# When using this override: if E2E runs on the host, keep stub ports in base compose for that job;
# or run Playwright in a container on synaplan-test-network with WHATSAPP_STUB_URL=http://whatsapp-stub:3999.
#
# Usage in CI:
#   docker compose -f docker-compose.test.yml -f docker-compose.test.ci.yml up

services:
  app_test:
    # Use pre-built image from CI (e.g., synaplan-test:ci)
    image: ${APP_IMAGE:-}
    # Remove all volume mounts to use the baked image content
    # The !reset tag is required to clear inherited volumes from base file
    volumes: !reset []

  whatsapp-stub:
    # CI: expose 3999 so Playwright (running on host) can reach stub at localhost:3999 for integration tests.
    # app_test reaches stub at http://whatsapp-stub:3999 via backend/.env.test (WHATSAPP_GRAPH_API_BASE_URL).
    ports: ["3999:3999"]
    # Same name as base compose so only one container name appears (no synaplan-whatsapp-stub-1)
    container_name: synaplan-whatsapp-stub
